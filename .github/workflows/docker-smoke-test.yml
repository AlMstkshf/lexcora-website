name: Docker image smoke test

on:
  workflow_run:
    workflows: ["Build and publish Docker image"]
    types: [completed]

jobs:
  smoke-test:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull image
        run: |
          docker pull ghcr.io/${{ github.repository_owner }}/lexcora-server:latest

      - name: Run container
        run: |
          docker run -d --name lexcora-smoke -e PORT=4000 -e API_KEY=smoke_test_key -e FRONTEND_ORIGINS=http://localhost:3000 -p 4001:4000 ghcr.io/${{ github.repository_owner }}/lexcora-server:latest

      - name: Wait for /health and assert OK
        run: |
          set -e
          i=0
          until [ $i -ge 30 ]; do
            if curl -sS http://localhost:4001/health | grep -q '"status".*"ok"'; then
              echo "Health check passed"
              exit 0
            fi
            i=$((i+1))
            echo "Waiting for service... ($i)"
            sleep 2
          done
          echo "Health check failed. Dumping container logs:" && docker logs lexcora-smoke || true
          docker rm -f lexcora-smoke || true
          exit 1

      - name: Cleanup
        if: always()
        run: |
          docker rm -f lexcora-smoke || true
